# Directed Spectrum #
This simple package provides code for estimating the directed spectrum, a measure of directed communication between timeseries.
A primary use case of the directed spectrum is the estimation of latent brain networks from recordings of neural activity.
To do so, use the `ds` function provided in this package to estimate directed spectrum values for your data, then apply a linear factor model, such as non-negative matrix factorization (NMF), to estimate latent networks from the data: 
```python
from dir_spec.ds import ds
from sklearn.decomposition import NMF

directed_spectrum = ds(neural_data, sampling_frequency, channel_names)

# format ds array for NMF
X = directed_spectrum.ds_array
X = X.reshape((X.shape[0], -1))

network_model = NMF(50, solver='mu', beta_loss=0, init='nndsvdar')
network_activations = network_model.fit_transform(X)
latent_networks = network_model.components_
```
The directed spectrum is compatible with the underlying assumptions of linear latent factor models for identifying latent brain networks from neural recordings, unlike other measures of directed communication (*eg* Granger causality).
These properties of the directed spectrum also extend to other applications where the goal is latent network discovery, as long as the medium through which the signal is recorded does not cause nonlinear distortions relative to the underlying signal generated by the unobserved networks.
The `ds` function within the `ds` module takes 2 required parameters, in addition to several optional parameters, and returns an object of the `DirectedSpectrum` class.

For more information on the directed spectrum please see the [associated publication](https://proceedings.neurips.cc/paper/2021/hash/3d36c07721a0a5a96436d6c536a132ec-Abstract.html):  
Gallagher, N., Dzirasa, K. & Carlson, D. (2021). Directed Spectral Measures Improve Latent Network Models Of Neural Populations. *Advances in Neural Information Processing Systems 34*.


## Use ##
This package has one public function: `ds`
```python
ds(X, f_samp, groups=None, pairwise=False, f_res=None, max_iter=1000,
       tol=1e-6, window=boxcar(200), nperseg=None, noverlap=None):
```
##### Parameters #####
* `X` : numpy.ndarray, shape (n_windows, n_channels, n_timepoints)  
        Timeseries data from multiple channels. It is assumed that the
        data for each channel are approximately stationary within a window.
        If a 2-D array is input, it is assumed that n_windows is 1.
* `f_samp` : float  
        Sampling rate associated with X.
* `groups` : list of strings, shape (n_channels), optional  
        To calculate the Directed Spectrum between groups of channels, this
        should list the group associated with each channel. Otherwise, to
        calculate the directed spectrum between each pair of channels, this
        should be a list of channel names. If 'None' (default), then each
        channel will be given a unique integer index.
* `pairwise` : bool, optional  
        If 'True', calculate the pairwise directed spectrum
        (i.e. calculate seperately for each pair of groups/channels).
        Otherwise, the non-pairwise directed spectrum will be calculated.
        Note the pairwise directed spectrum is not calculated for elements
        where the source and target are the same.
* `f_res` : float, optional  
        Frequency resolution of the calculated spectrum. For example, if
        set to 1, then the directed spectrum will be calculated for
        integer frequency values. If set to 'None' (the default), then
        the frequency resolution will be fs/nperseg.
* `max_iter` : int  
        Max number of Wilson factorization iterations. If factorization
        does not converge before reaching this value, directed spectrum
        estimates may be inaccurate.
* `tol` : float  
        Wilson factorization convergence tolerance value.
* `window` : str or tuple or array_like, optional  
        Desired window to use. If `window` is a string or tuple, it is
        passed to `get_window` to generate the window values, which are
        DFT-even by default. See `get_window` for a list of windows and
        required parameters. If `window` is array_like it will be used
        directly as the window and its length must be nperseg. Defaults
        to a Hann window.
* `nperseg` : int, optional  
        Length of each segment. Defaults to None, but if window is str or
        tuple, is set to 256, and if window is array_like, is set to the
        length of the window.
* `noverlap`: int, optional  
        Number of points to overlap between segments. If `None`,
        ``noverlap = nperseg // 2``. Defaults to `None`.
 
 *[Documentation for the `window`, `nperseg`, and `noverlap` variables was
        copied directly from the scipy.signal.spectral module. These
        variables are used for calculating the cross power spectral density
        matrix as an intermediate step in calculating the directed spectrum.]*


`ds` returns a `DirectedSpectrum` object.
```python
DirectedSpectrum(ds_array, f, cgroups)
```
##### Attributes #####
* `ds_array` : ndarray, shape (n_windows, n_frequencies, n_groups, n_groups)  
        Directed spectrum values between each pair of channels/groups
        for each frequency and window. Axis 2 corresponds to the source
        channel/group and axis 3 corresponds to the target channel/group.
        For pairwise directed spectrum, elements for which target and source
        are the same are not defined and are returned as NaNs. For 'full'
        models, elements for which the target and source are the same
        correspond to the self-directed spectrum, representing all signal
        in that region that is not explained by any of the other sources in
        the model.
* `f` : ndarray, shape (n_frequencies)  
        Frequencies associated with axis 1 of ds_array.
* `groups` : ndarray of strings, shape (n_groups)  
        Names the channels/groups associated with ds_array.
